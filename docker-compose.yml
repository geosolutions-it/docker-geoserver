x-geoserver-common: &geoserver-common
  image: geoserver-mbtiles:latest
  restart: unless-stopped

services:
  geoserver-ui:
    <<: *geoserver-common
    build:
      context: .
      dockerfile: ./Dockerfile
      args:
        GEOSERVER_WEBAPP_SRC: ./geoserver.war
        PLUG_IN_PATHS: ./resources/geoserver-plugins
    container_name: geoserver-ui
    deploy:
      resources:
        limits:
          memory: 4G
    environment:
      APP_LOCATION: "geoserver_ui"
      EXTRA_GEOSERVER_OPTS: "-Xmx3G -XX:MaxRAM=4g -DGEOSERVER_NODE_OPTS=id:backoffice-$${HOSTNAME} -DGEOSERVER_LOG_LOCATION=$${GEOSERVER_HOME}/logs/$${HOSTNAME}-backoffice.log -DGEOSERVER_AUDIT_PATH=$${GEOSERVER_HOME}/audit/geoserver-backoffice-$${HOSTNAME} -DGEOWEBCACHE_CONFIG_DIR=$${GEOSERVER_HOME}/gwc"
      CORS_ENABLED: true
      CORS_ALLOWED_ORIGINS: "*"
      CORS_ALLOWED_METHODS: "HEAD,POST,GET,OPTIONS,PUT"
      CORS_ALLOWED_HEADERS: "origin,x-requested-with,access-control-request-headers,content-type,access-control-request-method,accept"
      CORS_ALLOW_CREDENTIALS: false
    ports:
      - 8080
    volumes:
      - gs_audits:/var/geoserver/audit
      - gs_data:/var/geoserver/data
      - gs_datadir_backoffice:/var/geoserver/datadir
      - gs_logs:/var/geoserver/logs
      - gwc_cache:/var/geoserver/gwc_cache_dir
      - gwc_conf:/var/geoserver/gwc
    healthcheck:
      test: ["CMD-SHELL", "curl -f 'http://geoserver-ui:8080/geoserver_ui/ows?service=WMS&request=GetCapabilities&version=1.3.0' | grep '<Name>WMS</Name>'"]
      interval: 30s
      timeout: 20s
      retries: 5
      start_period: 30s

  geoserver:
    <<: *geoserver-common
    deploy:
      mode: replicated
      replicas: 1
      resources:
        limits:
          memory: 4G
    environment:
      APP_LOCATION: "geoserver"
      EXTRA_GEOSERVER_OPTS: "-Xmx3G -XX:MaxRAM=4g -DGEOSERVER_NODE_OPTS=id:$${HOSTNAME} -DGEOSERVER_LOG_LOCATION=$${GEOSERVER_HOME}/logs/$${HOSTNAME}.log -DGEOSERVER_AUDIT_PATH=$${GEOSERVER_HOME}/audit/geoserver-$${HOSTNAME} -DGEOWEBCACHE_CONFIG_DIR=$${GEOSERVER_HOME}/gwc"
      CORS_ENABLED: true
      CORS_ALLOWED_ORIGINS: "*"
      CORS_ALLOWED_METHODS: "HEAD,POST,GET,OPTIONS,PUT"
      CORS_ALLOWED_HEADERS: "origin,x-requested-with,access-control-request-headers,content-type,access-control-request-method,accept"
      CORS_ALLOW_CREDENTIALS: false
    # ports:
    #   - 8080
    volumes:
      - gs_audits:/var/geoserver/audit
      - gs_data:/var/geoserver/data
      - gs_datadir:/var/geoserver/datadir
      - gs_logs:/var/geoserver/logs
      - gwc_cache:/var/geoserver/gwc_cache_dir
      - gwc_conf:/var/geoserver/gwc
    healthcheck:
      test: ["CMD-SHELL", "curl -f 'http://geoserver:8080/geoserver/ows?service=WMS&request=GetCapabilities&version=1.3.0' | grep '<Name>WMS</Name>'"]
      interval: 30s
      timeout: 20s
      retries: 5
      start_period: 30s

  nginx:
    image: nginx:stable-bookworm-perl
    container_name: nginx
    restart: unless-stopped
    ports:
      - 80:80
    volumes:
      - ./geoserver.conf:/etc/nginx/conf.d/default.conf:rw

volumes:
  gs_audits:
  gs_data:
  gs_datadir_backoffice:
  gs_datadir:
  gs_logs:
  gwc_cache:
  gwc_conf:
