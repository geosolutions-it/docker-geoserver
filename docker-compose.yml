x-geoserver-common: &geoserver-common
  image: ghcr.io/seaislandsoftware/hvx-geoserver:dev
  pull_policy: always
  restart: unless-stopped

services:
  geoserver-ui:
    <<: *geoserver-common
    profiles:
      - master
    #build:
    #  context: .
    #  dockerfile: ./Dockerfile
    #  args:
    #    GEOSERVER_WEBAPP_SRC: ./geoserver.war
    #    PLUG_IN_PATHS: ./plugins
    #    GEOSERVER_DATA_DIR_SRC: ./hvx-geoserver-config
    environment:
      APP_LOCATION: "geoserver_ui"
      EXTRA_GEOSERVER_OPTS: "${EXTRA_GEOSERVER_OPTS}"
      AWS_ACCESS_KEY_ID: "${AWS_ACCESS_KEY_ID}"
      AWS_SECRET_KEY: "${AWS_SECRET_KEY}"
      POSTGRES_NHP_DATA_SIM_HOST: "${POSTGRES_NHP_DATA_SIM_HOST}"
      POSTGRES_NHP_DATA_SIM_PASSWORD: "${POSTGRES_NHP_DATA_SIM_PASSWORD}"
    container_name: geoserver-ui
    ports:
      - 8080:8080
    volumes:
      - /${MOUNT_POINT_GEO_DATA}:/geo-data
      - /${MOUNT_POINT_RASTER}:/raster
      - ${GEOSERVER_AUDIT_PATH}:/var/geoserver/audit
      - ${GEOSERVER_LOG_LOCATION}:${GEOSERVER_LOG_LOCATION}
      - ${GEOWEBCACHE_CACHE_DIR}:/var/geoserver/gwc_cache_dir
      - ${GEOWEBCACHE_CONFIG_DIR}:/var/geoserver/datadir/gwc
      - ${GRIB_CACHE_DIR}:/var/geoserver/grib_cache_dir
      - ${NETCDF_DATA_DIR}:/var/geoserver/netcdf_data_dir
      - ${TOMCAT_LOG_DIR}:/usr/local/tomcat/logs
      - ${GEOSERVERHOME}/context.xml:/usr/local/tomcat/conf/context.xml
      - ${GEOSERVERHOME}/server.xml:/usr/local/tomcat/conf/server.xml
      - ${GEOSERVERHOME}/s3.properties:/var/geoserver/datadir/s3.properties
      - ${GEOSERVERHOME}/data_dir_master/:/var/geoserver/datadir
    healthcheck:
      test: ["CMD-SHELL", "curl -f 'http://geoserver-ui:8080/geoserver_ui/ows?service=WMS&request=GetCapabilities&version=1.3.0' | grep '<Name>WMS</Name>'"]
      interval: 30s
      timeout: 20s
      retries: 5
      start_period: 30s

  geoserver:
    <<: *geoserver-common
    profiles:
      - slave
    # deploy:
    #   mode: replicated
    #   replicas: 2
    environment:
      APP_LOCATION: "geoserver"
      EXTRA_GEOSERVER_OPTS: "${EXTRA_GEOSERVER_OPTS}"
      AWS_ACCESS_KEY_ID: "${AWS_ACCESS_KEY_ID}"
      AWS_SECRET_KEY: "${AWS_SECRET_KEY}"
      POSTGRES_NHP_DATA_SIM_HOST: "${POSTGRES_NHP_DATA_SIM_HOST}"
      POSTGRES_NHP_DATA_SIM_PASSWORD: "${POSTGRES_NHP_DATA_SIM_PASSWORD}"
    ports:
      # - 8081-8082:8080
      - 8080:8080
    volumes:
      - /${MOUNT_POINT_GEO_DATA}:/geo-data
      - /${MOUNT_POINT_RASTER}:/raster
      - ${GEOSERVER_AUDIT_PATH}:/var/geoserver/audit
      - ${GEOSERVER_LOG_LOCATION}:${GEOSERVER_LOG_LOCATION}
      - ${GEOWEBCACHE_CACHE_DIR}:/var/geoserver/gwc_cache_dir
      - ${GEOWEBCACHE_CONFIG_DIR}:/var/geoserver/datadir/gwc
      - ${GRIB_CACHE_DIR}:/var/geoserver/grib_cache_dir
      - ${NETCDF_DATA_DIR}:/var/geoserver/netcdf_data_dir
      - ${TOMCAT_LOG_DIR}:/usr/local/tomcat/logs
      - ${GEOSERVERHOME}/context.xml:/usr/local/tomcat/conf/context.xml
      - ${GEOSERVERHOME}/server.xml:/usr/local/tomcat/conf/server.xml
      - ${GEOSERVERHOME}/s3.properties:/var/geoserver/datadir/s3.properties
    healthcheck:
      test: ["CMD-SHELL", "curl -f 'http://geoserver:8080/geoserver/ows?service=WMS&request=GetCapabilities&version=1.3.0' | grep '<Name>WMS</Name>'"]
      interval: 30s
      timeout: 20s
      retries: 5
      start_period: 30s
