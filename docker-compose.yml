x-geoserver-common: &geoserver-common
  image: ${IMAGE}
  restart: unless-stopped

services:
  geoserver-ui:
    <<: *geoserver-common
    build:
      context: .
      dockerfile: ./Dockerfile
      args:
        GEOSERVER_WEBAPP_SRC: ./geoserver.war
        PLUG_IN_PATHS: ./resources/geoserver-plugins
    container_name: geoserver-ui
    deploy:
      resources:
        limits:
          memory: ${GEOSERVER_BACKOFFICE_MEMORY_LIMIT}
    environment:
      APP_LOCATION: "geoserver_ui"
      EXTRA_GEOSERVER_OPTS: "-Xmx${GEOSERVER_BACKOFFICE_XMX} -XX:MaxRAM=${GEOSERVER_BACKOFFICE_MEMORY_LIMIT} -DGEOSERVER_NODE_OPTS=id:backoffice-$${HOSTNAME} -DGEOSERVER_LOG_LOCATION=$${GEOSERVER_HOME}/logs/$${HOSTNAME}-backoffice.log -DGEOSERVER_AUDIT_PATH=$${GEOSERVER_HOME}/audit/geoserver-backoffice-$${HOSTNAME} -DGEOWEBCACHE_CONFIG_DIR=$${GEOSERVER_HOME}/gwc -DPROXY_BASE_URL=${PROXY_BASE_URL_BACKOFFICE}"
      CORS_ENABLED: true
      CORS_ALLOWED_ORIGINS: "*"
      CORS_ALLOWED_METHODS: "HEAD,POST,GET,OPTIONS,PUT"
      CORS_ALLOWED_HEADERS: "origin,x-requested-with,access-control-request-headers,content-type,access-control-request-method,accept"
      CORS_ALLOW_CREDENTIALS: false
    ports:
      - 8080
    volumes:
      - gs_audits:/var/geoserver/audit
      - ${DATA}:/var/geoserver/data
      - ${DATADIR_BACKOFFICE}:/var/geoserver/datadir
      - gs_logs:/var/geoserver/logs
      - gwc_cache:/var/geoserver/gwc_cache_dir
      - ${GWC_CONF}:/var/geoserver/gwc
    healthcheck:
      test: ["CMD-SHELL", "curl -f 'http://geoserver-ui:8080/geoserver_ui/ows?service=WMS&request=GetCapabilities&version=1.3.0' | grep '<Name>WMS</Name>'"]
      interval: 5s
      timeout: 5s
      retries: 5
      start_period: 20s

  geoserver:
    <<: *geoserver-common
    deploy:
      mode: replicated
      replicas: 1
      resources:
        limits:
          memory: ${GEOSERVER_MEMORY_LIMIT}
    environment:
      APP_LOCATION: "geoserver"
      EXTRA_GEOSERVER_OPTS: "-Xmx${GEOSERVER_XMX} -XX:MaxRAM=${GEOSERVER_MEMORY_LIMIT} -DGEOSERVER_NODE_OPTS=id:$${HOSTNAME} -DGEOSERVER_LOG_LOCATION=$${GEOSERVER_HOME}/logs/$${HOSTNAME}.log -DGEOSERVER_AUDIT_PATH=$${GEOSERVER_HOME}/audit/geoserver-$${HOSTNAME} -DGEOWEBCACHE_CONFIG_DIR=$${GEOSERVER_HOME}/gwc -DPROXY_BASE_URL=${PROXY_BASE_URL}"
      CORS_ENABLED: true
      CORS_ALLOWED_ORIGINS: "*"
      CORS_ALLOWED_METHODS: "HEAD,POST,GET,OPTIONS,PUT"
      CORS_ALLOWED_HEADERS: "origin,x-requested-with,access-control-request-headers,content-type,access-control-request-method,accept"
      CORS_ALLOW_CREDENTIALS: false
    volumes:
      - gs_audits:/var/geoserver/audit
      - ${DATA}:/var/geoserver/data
      - ${DATADIR}:/var/geoserver/datadir
      - gs_logs:/var/geoserver/logs
      - gwc_cache:/var/geoserver/gwc_cache_dir
      - ${GWC_CONF}:/var/geoserver/gwc
    healthcheck:
      test: ["CMD-SHELL", "curl -f 'http://geoserver:8080/geoserver/ows?service=WMS&request=GetCapabilities&version=1.3.0' | grep '<Name>WMS</Name>'"]
      interval: 5s
      timeout: 5s
      retries: 5
      start_period: 20s

  nginx:
    image: nginx:stable-bookworm-perl
    container_name: nginx
    restart: unless-stopped
    ports:
      - ${NGINX_HTTP_PORT}:80
    volumes:
      - ./geoserver.conf:/etc/nginx/conf.d/default.conf:rw

volumes:
  gs_audits:
  gs_logs:
  gwc_cache:
